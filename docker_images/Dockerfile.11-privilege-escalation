FROM ubuntu:20.04

ENV DEBIAN_FRONTEND=noninteractive

# Create users
RUN useradd -m -s /bin/bash lowpriv && \
    echo 'lowpriv:password123' | chpasswd && \
    useradd -m -s /bin/bash root2 && \
    echo 'root2:admin' | chpasswd

# Create flag
RUN echo 'CTF{r00t_4cc3ss}' > /root/flag.txt && \
    chmod 600 /root/flag.txt

# Create SUID binary vulnerability
RUN echo '#!/bin/bash' > /usr/local/bin/backup && \
    echo 'echo "=== Backup Script ==="' >> /usr/local/bin/backup && \
    echo 'echo "Backing up user files..."' >> /usr/local/bin/backup && \
    echo 'if [ "$1" = "--read-flag" ]; then' >> /usr/local/bin/backup && \
    echo '  cat /root/flag.txt' >> /usr/local/bin/backup && \
    echo 'else' >> /usr/local/bin/backup && \
    echo '  echo "Backup completed!"' >> /usr/local/bin/backup && \
    echo 'fi' >> /usr/local/bin/backup && \
    chmod 4755 /usr/local/bin/backup && \
    chown root:root /usr/local/bin/backup

# Install web server
RUN apt-get update && \
    apt-get install -y nginx && \
    apt-get clean

# Create web interface
RUN echo '<!DOCTYPE html>' > /var/www/html/index.html && \
    echo '<html><head><title>Privilege Escalation</title>' >> /var/www/html/index.html && \
    echo '<style>' >> /var/www/html/index.html && \
    echo 'body { background: #0a0e27; color: #00ff41; font-family: monospace; padding: 30px; }' >> /var/www/html/index.html && \
    echo 'button { background: #00ff41; color: #0a0e27; padding: 10px 20px; border: none; cursor: pointer; margin: 5px; }' >> /var/www/html/index.html && \
    echo 'pre { background: #1a1a2e; padding: 15px; border: 1px solid #00f5ff; overflow-x: auto; }' >> /var/www/html/index.html && \
    echo 'input { background: #1a1a2e; border: 1px solid #00ff41; color: #00ff41; padding: 10px; width: 400px; }' >> /var/www/html/index.html && \
    echo '</style></head><body>' >> /var/www/html/index.html && \
    echo '<h1>üîê PRIVILEGE ESCALATION CHALLENGE</h1>' >> /var/www/html/index.html && \
    echo '<p>You are logged in as user <code>lowpriv</code>. Escalate to root!</p>' >> /var/www/html/index.html && \
    echo '<div>' >> /var/www/html/index.html && \
    echo '<button onclick="whoami()">whoami</button>' >> /var/www/html/index.html && \
    echo '<button onclick="listSUID()">Find SUID binaries</button>' >> /var/www/html/index.html && \
    echo '<button onclick="checkPerms()">Check permissions</button>' >> /var/www/html/index.html && \
    echo '</div>' >> /var/www/html/index.html && \
    echo '<div>' >> /var/www/html/index.html && \
    echo '<input id="command" placeholder="Enter command">' >> /var/www/html/index.html && \
    echo '<button onclick="runCommand()">Execute</button>' >> /var/www/html/index.html && \
    echo '</div>' >> /var/www/html/index.html && \
    echo '<div id="output"></div>' >> /var/www/html/index.html && \
    echo '<hr><h3>üí° Hints:</h3>' >> /var/www/html/index.html && \
    echo '<ul>' >> /var/www/html/index.html && \
    echo '<li>Look for SUID binaries with: find / -perm -4000 2>/dev/null</li>' >> /var/www/html/index.html && \
    echo '<li>SUID binaries run with owner'\''s privileges (usually root)</li>' >> /var/www/html/index.html && \
    echo '<li>There'\''s a vulnerable backup script in /usr/local/bin/</li>' >> /var/www/html/index.html && \
    echo '<li>Try: /usr/local/bin/backup --read-flag</li>' >> /var/www/html/index.html && \
    echo '</ul>' >> /var/www/html/index.html && \
    echo '<script>' >> /var/www/html/index.html && \
    echo 'function whoami() {' >> /var/www/html/index.html && \
    echo '  document.getElementById("output").innerHTML = `' >> /var/www/html/index.html && \
    echo '    <h3>Current User:</h3>' >> /var/www/html/index.html && \
    echo '    <pre>lowpriv</pre>' >> /var/www/html/index.html && \
    echo '  `;' >> /usr/share/nginx/html/index.html && \
    echo '}' >> /var/www/html/index.html && \
    echo 'function listSUID() {' >> /var/www/html/index.html && \
    echo '  document.getElementById("output").innerHTML = `' >> /var/www/html/index.html && \
    echo '    <h3>SUID Binaries Found:</h3>' >> /var/www/html/index.html && \
    echo '    <pre>' >> /var/www/html/index.html && \
    echo '/usr/bin/sudo' >> /var/www/html/index.html && \
    echo '/usr/bin/passwd' >> /var/www/html/index.html && \
    echo '/usr/bin/su' >> /var/www/html/index.html && \
    echo '/usr/local/bin/backup  ‚Üê UNUSUAL!' >> /var/www/html/index.html && \
    echo '    </pre>' >> /var/www/html/index.html && \
    echo '    <p style="color: #00f5ff;">üí° /usr/local/bin/backup looks suspicious!</p>' >> /var/www/html/index.html && \
    echo '  `;' >> /var/www/html/index.html && \
    echo '}' >> /var/www/html/index.html && \
    echo 'function checkPerms() {' >> /var/www/html/index.html && \
    echo '  document.getElementById("output").innerHTML = `' >> /var/www/html/index.html && \
    echo '    <h3>File Permissions:</h3>' >> /var/www/html/index.html && \
    echo '    <pre>' >> /var/www/html/index.html && \
    echo '-rwsr-xr-x 1 root root /usr/local/bin/backup' >> /var/www/html/index.html && \
    echo '' >> /var/www/html/index.html && \
    echo 'The "s" in permissions means SUID is set!' >> /var/www/html/index.html && \
    echo 'This binary runs with root privileges.' >> /var/www/html/index.html && \
    echo '    </pre>' >> /var/www/html/index.html && \
    echo '  `;' >> /var/www/html/index.html && \
    echo '}' >> /var/www/html/index.html && \
    echo 'function runCommand() {' >> /var/www/html/index.html && \
    echo '  const cmd = document.getElementById("command").value;' >> /var/www/html/index.html && \
    echo '  if (cmd.includes("backup") && cmd.includes("--read-flag")) {' >> /var/www/html/index.html && \
    echo '    document.getElementById("output").innerHTML = `' >> /var/www/html/index.html && \
    echo '      <h3>Command Output:</h3>' >> /var/www/html/index.html && \
    echo '      <pre>' >> /var/www/html/index.html && \
    echo '$ ${cmd}' >> /var/www/html/index.html && \
    echo 'üéâ Flag: CTF{r00t_4cc3ss}' >> /var/www/html/index.html && \
    echo '' >> /var/www/html/index.html && \
    echo 'Congratulations! You escalated to root privileges!' >> /var/www/html/index.html && \
    echo '      </pre>' >> /var/www/html/index.html && \
    echo '    `;' >> /var/www/html/index.html && \
    echo '  } else {' >> /var/www/html/index.html && \
    echo '    document.getElementById("output").innerHTML = `' >> /var/www/html/index.html && \
    echo '      <h3>Command Output:</h3>' >> /var/www/html/index.html && \
    echo '      <pre>$ ${cmd}\\n-bash: ${cmd}: command not found</pre>' >> /var/www/html/index.html && \
    echo '    `;' >> /var/www/html/index.html && \
    echo '  }' >> /var/www/html/index.html && \
    echo '}' >> /var/www/html/index.html && \
    echo '</script>' >> /var/www/html/index.html && \
    echo '</body></html>' >> /var/www/html/index.html

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]

# Build: docker build -t cyberlab/11-privilege-escalation:v1 -f Dockerfile.11-privilege-escalation .
# Run: docker run -p 8011:80 cyberlab/11-privilege-escalation:v1